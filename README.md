# Дипломный проект «Backend приложение для автоматизации закупок»

[![Python Tests](https://github.com/Timons172/Orders_backend_app/actions/workflows/tests.yml/badge.svg)](https://github.com/Timons172/Orders_backend_app/actions/workflows/tests.yml)
![Coverage](./coverage.svg)

## Описание проекта

API приложение на базе Django REST Framework для автоматизации закупок в розничной сети. Система позволяет клиентам делать заказы товаров от различных поставщиков, а поставщикам управлять товарами и получать информацию о заказах.

## Основные возможности

- Регистрация и авторизация пользователей
- Возможность загрузки аватаров пользователей и изображений товаров
- Автоматическое создание миниатюр изображений различных размеров
- Каталог товаров с фильтрацией по категориям, магазинам и поиском
- Корзина для сбора товаров от разных поставщиков 
- Оформление заказов с указанием адреса доставки
- Отслеживание статуса заказов
- Email-уведомления о регистрации и статусе заказов
- Административный интерфейс с расширенным функционалом (Django JET Reboot)
- Ограничение частоты запросов (Rate Limiting) для защиты API
- Кэширование данных для ускорения работы приложения
- Импорт товаров из YAML-файлов

## Технологический стек

- **Язык:** Python 3.8+
- **Framework:** Django 5.0+, Django REST Framework 3.14+
- **База данных:** SQLite
- **Инструменты:** Docker, Docker Compose
- **Асинхронные задачи:** Celery 5.3+, Redis 4.6+
- **Кэширование:** Redis, django-cachalot
- **Обработка изображений:** django-versatileimagefield 3.0+
- **Административный интерфейс:** Django JET Reboot
- **Дополнительно:** Email notifications, API throttling, YAML parser

## Структура проекта

Основные компоненты системы:

- **Модели данных:**
  - UserProfile - профиль пользователя с аватаром
  - Shop - магазины/поставщики товаров
  - Category - категории товаров
  - Product - товары с изображениями
  - ProductInfo - информация о товарах в магазинах
  - Parameter - параметры товаров
  - ProductParameter - значения параметров для конкретных товаров
  - Order - заказы пользователей
  - OrderItem - товары в заказах
  - Contact - контактная информация пользователей

- **API эндпоинты:**
  - `/api/user/register/` - регистрация
  - `/api/user/login/` - авторизация
  - `/api/user/avatar/` - загрузка аватара пользователя
  - `/api/products/` - список товаров
  - `/api/products/{id}/` - детали товара
  - `/api/products/{id}/image/` - загрузка изображения товара
  - `/api/product-info/` - детальная информация о товарах с фильтрами
  - `/api/cart/` - управление корзиной
  - `/api/contacts/` - управление контактами пользователя
  - `/api/orders/` - управление заказами

## Установка и запуск 

### Вариант 1: Локальный запуск

1. Клонировать репозиторий:
```bash
git clone <repository-url>
cd Orders_backend_app
```

2. Создать и активировать виртуальное окружение:
```bash
python -m venv venv
source venv/bin/activate  # Linux/macOS
# или
venv\Scripts\activate  # Windows
```

3. Установить зависимости:
```bash
pip install -r requirements.txt
```

4. Выполнить миграции:
```bash
python manage.py migrate
```

5. Загрузить тестовые данные:
```bash
python manage.py import_products backend/fixtures/shop.yaml
```

6. Создать суперпользователя:
```bash
python manage.py createsuperuser
```

7. Запустить сервер:
```bash
python manage.py runserver
```

Приложение будет доступно по адресу: http://127.0.0.1:8000/

### Вариант 2: Запуск в Docker

#### Предварительные требования

1. Установленный Docker (версия 19.03 или выше)
2. Установленный Docker Compose (версия 1.25 или выше)

#### Подготовка к запуску

1. Клонировать репозиторий:
```bash
git clone <repository-url>
cd Orders_backend_app
```

#### Запуск с использованием Docker Compose (рекомендуется)

1. Собрать и запустить контейнер:
```bash
docker-compose up --build
```

2. После запуска сервер будет доступен по адресу http://localhost:8000/

3. Для остановки контейнера:
```bash
docker-compose down
```

#### Управление Docker-контейнером

**Создание суперпользователя:**
```bash
docker-compose exec web python manage.py createsuperuser
```

## API документация

Приложение предоставляет следующие API эндпоинты:

### Аутентификация и авторизация

- `POST /api/user/register/` - Регистрация нового пользователя
  - Тело запроса: `{"username": "user", "email": "user@example.com", "first_name": "John", "last_name": "Doe", "password": "secure_password", "password_repeat": "secure_password"}`
  - Ответ: `{"token": "ваш_токен_аутентификации", "user": {"id": 1, "username": "user", ...}}`

- `POST /api/user/login/` - Вход в систему и получение токена
  - Тело запроса: `{"username": "user", "password": "secure_password"}`
  - Ответ: `{"token": "ваш_токен_аутентификации", "user": {"id": 1, "username": "user", ...}}`

### Использование токена для доступа к защищенным эндпоинтам

После успешной регистрации или авторизации вы получите токен. Этот токен необходимо передавать в заголовке `Authorization` для всех запросов к защищенным эндпоинтам (корзина, заказы, контакты):

```
Authorization: Token ваш_токен_аутентификации
```

Пример с использованием curl:
```bash
curl -H "Authorization: Token <your_token>" http://localhost:8000/api/cart/
```

### Управление аватаром пользователя

- `POST /api/user/avatar/` - Загрузка аватара пользователя
  - Запрос: `multipart/form-data` с полями `avatar` (файл изображения) и опционально `avatar_ppoi` (точка интереса для обрезки)
  - Ответ: Данные пользователя со ссылками на аватар в разных размерах

- `DELETE /api/user/avatar/` - Удаление аватара пользователя

### Товары и каталог

- `GET /api/products/` - Получение списка всех товаров
- `GET /api/products/{id}/` - Детали конкретного товара
- `POST /api/products/{id}/image/` - Загрузка изображения товара
  - Запрос: `multipart/form-data` с полями `image` (файл изображения) и опционально `image_ppoi` (точка интереса для обрезки)
  - Ответ: Данные товара со ссылками на изображение в разных размерах
- `DELETE /api/products/{id}/image/` - Удаление изображения товара
- `GET /api/product-info/` - Информация о товарах с ценами и параметрами
  - Поддерживает параметры: `?shop={id}`, `?category={id}`, `?search={query}`

### Корзина

- `GET /api/cart/` - Получение текущей корзины
- `POST /api/cart/` - Добавление товара в корзину
  - Тело запроса: `{"product": id, "shop": id, "quantity": количество}`
- `DELETE /api/cart/` - Удаление товара из корзины
  - Тело запроса: `{"item_id": id}`

### Контакты и адреса

- `GET /api/contacts/` - Получение списка контактов/адресов
- `POST /api/contacts/` - Создание нового контакта
  - Тело запроса: `{"type": "address", "value": "Адрес доставки"}`

### Заказы

- `GET /api/orders/` - Получение списка оформленных заказов
- `POST /api/orders/` - Оформление заказа
  - Тело запроса: `{"contact_id": id}`
- `GET /api/orders/{id}/` - Детали конкретного заказа

## Административный интерфейс

Административный интерфейс доступен по адресу: http://localhost:8000/admin/

В проекте используется расширение Django JET Reboot, которое предоставляет улучшенный интерфейс администратора с дополнительными возможностями:
- Современный дизайн в стиле Material Design
- Улучшенная навигация и поиск
- Настраиваемые дашборды и виджеты
- Фильтры и группировка данных
- Улучшенные формы редактирования

Вы можете использовать административный интерфейс для:
- Управления пользователями
- Добавления/изменения товаров и категорий
- Просмотра и редактирования заказов
- Изменения статусов заказов

## Swagger UI — автогенерация документации

Для удобной работы с API и тестирования всех эндпоинтов доступна автогенерируемая интерактивная документация Swagger UI:

- Swagger UI: http://localhost:8000/api/schema/swagger-ui/

В Swagger UI можно:
- Просматривать структуру всех эндпоинтов
- Смотреть примеры запросов и ответов
- Выполнять запросы к API прямо из браузера (при необходимости — с авторизацией)

Документация формируется автоматически на основе кода и сериализаторов.

## Тестирование

Проект покрыт автоматическими тестами, использующими pytest и pytest-django. Для запуска тестов и проверки покрытия кода выполните:

```bash
# Локально
pytest

# В Docker
docker-compose exec web pytest
```

### Покрытие кода

Для проверки покрытия кода используется инструмент coverage, интегрированный с pytest:

```bash
# Запуск тестов с проверкой покрытия
pytest --cov=backend

# Генерация HTML-отчета о покрытии
pytest --cov=backend --cov-report=html
```

После выполнения команды будет создана директория `htmlcov` с отчетом о покрытии. Откройте файл `htmlcov/index.html` в браузере для просмотра детального отчета.

### Непрерывная интеграция

Проект настроен на автоматическое выполнение тестов при каждом push в master/main ветку и при создании pull request с использованием GitHub Actions. Результаты тестов и покрытие кода отображаются в виде бейджа в README.

## Асинхронные задачи с Celery

Проект использует Celery для выполнения следующих асинхронных задач:

### Email-уведомления

- Отправка email-подтверждений при регистрации пользователей
- Отправка уведомлений о статусе заказа
- Массовая рассылка по клиентской базе

### Обработка заказов

- Автоматическая обработка новых заказов
- Периодическая проверка и обновление статусов заказов

### Обновление данных о товарах

- Асинхронное обновление наличия товаров в магазинах
- Обновление цен и характеристик товаров

### Обработка изображений

- Асинхронное создание миниатюр изображений для аватаров пользователей
- Асинхронное создание миниатюр изображений для товаров
- Оптимизация изображений для улучшения производительности веб-приложения

## Хранение и форматы изображений

Система поддерживает загрузку изображений в следующих форматах:
- JPEG/JPG
- PNG
- GIF
- WebP

Для каждого типа изображения создаются следующие миниатюры:

### Аватары пользователей
- Полный размер (исходное изображение)
- Миниатюра 50x50px (thumbnail)
- Среднее изображение 150x150px (medium)
- Квадратная обрезка 200x200px (square_crop)

### Изображения товаров
- Полный размер (исходное изображение)
- Миниатюра 100x100px (thumbnail)
- Среднее изображение 300x300px (medium)
- Большое изображение 600x600px (large)
- Квадратная обрезка 400x400px (square_crop)

При загрузке изображений можно указать PPOI (Primary Point of Interest) - основную точку интереса для лучшей обрезки изображений.

## Кэширование и оптимизация производительности

Для повышения производительности приложения используется многоуровневая система кэширования:

### Redis Cache

В качестве основного бэкенда для кэширования используется Redis - быстрое in-memory хранилище данных. Настроен кэш по умолчанию и отдельный кэш для ограничения запросов (throttling).

### Django-cachalot

Библиотека django-cachalot обеспечивает автоматическое кэширование запросов к базе данных:
- Автоматическое кэширование результатов SQL-запросов
- Инвалидация кэша при изменении данных
- Поддержка нескольких уровней кэширования
- Значительное сокращение времени ответа для повторных запросов

### Настройки кэширования

Кэширование настроено для:
- Результатов запросов к базе данных
- API-запросов (через ETag и conditional requests)
- Статического контента
- Шаблонов и фрагментов страниц

## Безопасность и ограничение частоты запросов

### Ограничение частоты запросов (Throttling)

Для защиты API от злоупотреблений и DDoS-атак настроено ограничение частоты запросов:
- Анонимные пользователи: 60 запросов в минуту
- Авторизованные пользователи: 600 запросов в минуту

Это помогает защитить сервер от перегрузок и обеспечивает стабильную работу API для всех клиентов.

### Дополнительные меры безопасности

- Защита от CSRF-атак
- Безопасное хранение паролей
- Валидация входящих данных
- Безопасные настройки HTTP-заголовков