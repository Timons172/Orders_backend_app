# Дипломный проект «Backend приложение для автоматизации закупок»

[![Python Tests](https://github.com/Timons172/Orders_backend_app/actions/workflows/tests.yml/badge.svg)](https://github.com/Timons172/Orders_backend_app/actions/workflows/tests.yml)
![Coverage](./coverage.svg)

## Описание проекта

API приложение на базе Django REST Framework для автоматизации закупок в розничной сети. Система позволяет клиентам делать заказы товаров от различных поставщиков, а поставщикам управлять товарами и получать информацию о заказах.

## Основные возможности

- Регистрация и авторизация пользователей
- Каталог товаров с фильтрацией по категориям, магазинам и поиском
- Корзина для сбора товаров от разных поставщиков 
- Оформление заказов с указанием адреса доставки
- Отслеживание статуса заказов
- Email-уведомления о регистрации и статусе заказов
- Административный интерфейс для управления контентом и заказами
- Импорт товаров из YAML-файлов

## Технологический стек

- **Язык:** Python 3.8+
- **Framework:** Django 5.0+, Django REST Framework 3.14+
- **База данных:** SQLite
- **Инструменты:** Docker, Docker Compose
- **Асинхронные задачи:** Celery 5.3+, Redis 4.6+
- **Дополнительно:** Email notifications, YAML parser

## Структура проекта

Основные компоненты системы:

- **Модели данных:**
  - Shop - магазины/поставщики товаров
  - Category - категории товаров
  - Product - товары
  - ProductInfo - информация о товарах в магазинах
  - Parameter - параметры товаров
  - ProductParameter - значения параметров для конкретных товаров
  - Order - заказы пользователей
  - OrderItem - товары в заказах
  - Contact - контактная информация пользователей

- **API эндпоинты:**
  - `/api/user/register/` - регистрация
  - `/api/user/login/` - авторизация
  - `/api/products/` - список товаров
  - `/api/product-info/` - детальная информация о товарах с фильтрами
  - `/api/cart/` - управление корзиной
  - `/api/contacts/` - управление контактами пользователя
  - `/api/orders/` - управление заказами

## Установка и запуск 

### Вариант 1: Локальный запуск

1. Клонировать репозиторий:
```bash
git clone <repository-url>
cd Orders_backend_app
```

2. Создать и активировать виртуальное окружение:
```bash
python -m venv venv
source venv/bin/activate  # Linux/macOS
# или
venv\Scripts\activate  # Windows
```

3. Установить зависимости:
```bash
pip install -r requirements.txt
```

4. Выполнить миграции:
```bash
python manage.py migrate
```

5. Загрузить тестовые данные:
```bash
python manage.py import_products backend/fixtures/shop.yaml
```

6. Создать суперпользователя:
```bash
python manage.py createsuperuser
```

7. Запустить сервер:
```bash
python manage.py runserver
```

Приложение будет доступно по адресу: http://127.0.0.1:8000/

### Вариант 2: Запуск в Docker

#### Предварительные требования

1. Установленный Docker (версия 19.03 или выше)
2. Установленный Docker Compose (версия 1.25 или выше)

#### Подготовка к запуску

1. Клонировать репозиторий:
```bash
git clone <repository-url>
cd Orders_backend_app
```

#### Запуск с использованием Docker Compose (рекомендуется)

1. Собрать и запустить контейнер:
```bash
docker-compose up --build
```

2. После запуска сервер будет доступен по адресу http://localhost:8000/

3. Для остановки контейнера:
```bash
docker-compose down
```

#### Управление Docker-контейнером

**Создание суперпользователя:**
```bash
docker-compose exec web python manage.py createsuperuser
```

## API документация

Приложение предоставляет следующие API эндпоинты:

### Аутентификация и авторизация

- `POST /api/user/register/` - Регистрация нового пользователя
  - Тело запроса: `{"username": "user", "email": "user@example.com", "first_name": "John", "last_name": "Doe", "password": "secure_password", "password_repeat": "secure_password"}`
  - Ответ: `{"token": "ваш_токен_аутентификации", "user": {"id": 1, "username": "user", ...}}`

- `POST /api/user/login/` - Вход в систему и получение токена
  - Тело запроса: `{"username": "user", "password": "secure_password"}`
  - Ответ: `{"token": "ваш_токен_аутентификации", "user": {"id": 1, "username": "user", ...}}`

### Использование токена для доступа к защищенным эндпоинтам

После успешной регистрации или авторизации вы получите токен. Этот токен необходимо передавать в заголовке `Authorization` для всех запросов к защищенным эндпоинтам (корзина, заказы, контакты):

```
Authorization: Token ваш_токен_аутентификации
```

Пример с использованием curl:
```bash
curl -H "Authorization: Token <your_token>" http://localhost:8000/api/cart/
```

### Товары и каталог

- `GET /api/products/` - Получение списка всех товаров
- `GET /api/products/{id}/` - Детали конкретного товара
- `GET /api/product-info/` - Информация о товарах с ценами и параметрами
  - Поддерживает параметры: `?shop={id}`, `?category={id}`, `?search={query}`

### Корзина

- `GET /api/cart/` - Получение текущей корзины
- `POST /api/cart/` - Добавление товара в корзину
  - Тело запроса: `{"product": id, "shop": id, "quantity": количество}`
- `DELETE /api/cart/` - Удаление товара из корзины
  - Тело запроса: `{"item_id": id}`

### Контакты и адреса

- `GET /api/contacts/` - Получение списка контактов/адресов
- `POST /api/contacts/` - Создание нового контакта
  - Тело запроса: `{"type": "address", "value": "Адрес доставки"}`

### Заказы

- `GET /api/orders/` - Получение списка оформленных заказов
- `POST /api/orders/` - Оформление заказа
  - Тело запроса: `{"contact_id": id}`
- `GET /api/orders/{id}/` - Детали конкретного заказа

## Административный интерфейс

Административный интерфейс доступен по адресу: http://localhost:8000/admin/

Вы можете использовать его для:
- Управления пользователями
- Добавления/изменения товаров и категорий
- Просмотра и редактирования заказов
- Изменения статусов заказов

## Тестирование

Проект покрыт автоматическими тестами, использующими pytest и pytest-django. Для запуска тестов и проверки покрытия кода выполните:

```bash
# Локально
pytest

# В Docker
docker-compose exec web pytest
```

### Покрытие кода

Для проверки покрытия кода используется инструмент coverage, интегрированный с pytest:

```bash
# Запуск тестов с проверкой покрытия
pytest --cov=backend

# Генерация HTML-отчета о покрытии
pytest --cov=backend --cov-report=html
```

После выполнения команды будет создана директория `htmlcov` с отчетом о покрытии. Откройте файл `htmlcov/index.html` в браузере для просмотра детального отчета.

### Непрерывная интеграция

Проект настроен на автоматическое выполнение тестов при каждом push в master/main ветку и при создании pull request с использованием GitHub Actions. Результаты тестов и покрытие кода отображаются в виде бейджа в README.

## Асинхронные задачи с Celery

Проект использует Celery для выполнения следующих асинхронных задач:

### Email-уведомления

- Отправка email-подтверждений при регистрации пользователей
- Отправка уведомлений о статусе заказа
- Массовая рассылка по клиентской базе

### Обработка заказов

- Автоматическая обработка новых заказов
- Периодическая проверка и обновление статусов заказов

### Обновление данных о товарах

- Асинхронное обновление наличия товаров в магазинах
- Обновление цен и характеристик товаров